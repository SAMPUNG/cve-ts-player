import { ControlSchemeType, InputOptions } from '@cve-ts/dictionary'

import { getBooleanAttribute, player } from '../player/custom-element'
import { emitCustomEvent, emitDebugEvent } from '../player/emitter'
import { reconnect, start } from '../player/play-control'
import { onResizePlayerStyle } from '../style/events'
import {
  registerHoveringMouseEvents,
  registerLockedMouseEvents,
  registerMouseEnterAndLeaveEvents,
  registerTouchEvents,
} from '../video/events'

import {
  createOffer,
  onWebRtcAnswer,
  onWebRtcIce,
  pc,
  updatePeerConnection,
} from './peer-connection'

interface ParOptions {
  autoPlayAudio?: boolean
  startVideoMuted?: boolean
  bundlePolicy?: RTCIceTransportPolicy
  iceTransportPolicy?: RTCIceTransportPolicy
  peerConnectionOptions?: RTCConfiguration
}

export let ws: WebSocket | undefined

export function createWebSocket(url: string) {
  const GlobalWebSocket = window.WebSocket || window.MozWebSocket

  if (!GlobalWebSocket) {
    alert("Your browser doesn't support WebSocket")
    return
  }

  ws = new GlobalWebSocket(url.replace(/^http(s{0,1}:\/\/)/, 'ws$1'))

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data)
    console.log(
      '%c[ws]',
      'background: lime; color: black',
      'message ===> ',
      msg
    )
    switch (msg.type) {
      case 'config': {
        onConfig(msg)
        break
      }
      case 'playerCount': {
        emitDebugEvent('kick', msg.count - 1)
        break
      }
      case 'answer': {
        onWebRtcAnswer(msg as RTCSessionDescriptionInit)
        break
      }
      case 'iceCandidate': {
        onWebRtcIce(msg.candidate)
        break
      }
      default: {
      }
    }
  }

  ws.onclose = (event) => {
    console.log(
      '%c[ws]',
      'background: gery; color: black',
      'close ===> ',
      event.reason
    )
    if (player) {
      player.ready = false
    }

    updateWebSocket()
    reconnect(false)

    pc?.close()
    updatePeerConnection()

    emitDebugEvent('text', `Disconnected: ${event.reason}`)
    setTimeout(() => {
      start(url)
    }, 4000)
    emitCustomEvent('stop', event.reason)
  }
}

export function onConfig(options: ParOptions) {
  const config: RTCConfiguration = options.peerConnectionOptions ?? {
    bundlePolicy: getBooleanAttribute('force-max-bundle')
      ? 'max-bundle'
      : 'balanced',
    iceTransportPolicy: getBooleanAttribute('force-max-bundle')
      ? 'relay'
      : 'all',
  }

  emitDebugEvent('text', `Starting connection to server, please wait`)
  emitDebugEvent('setup', 'config')

  createOffer(config)

  onResizePlayerStyle()

  switch (InputOptions.ControlScheme) {
    case ControlSchemeType.HoveringMouse:
      registerHoveringMouseEvents()
      break
    case ControlSchemeType.LockedMouse:
      registerLockedMouseEvents()
      break
    default:
      registerLockedMouseEvents()
      break
  }

  registerMouseEnterAndLeaveEvents()
  registerTouchEvents()
}

export function updateWebSocket(socket?: WebSocket) {
  ws = socket
}

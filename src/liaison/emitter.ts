import { MessageType } from '@cve-ts/dictionary'

import { emitDebugEvent } from '../player/emitter'

import { dc } from './data-channel'

import { UIDescriptor } from '~/types/liaison/emitter'

export function emitCommand(descriptor: UIDescriptor) {
  emitDescriptor(MessageType.Command, descriptor)
}

export function emitDescriptor(messageType: number, descriptor: UIDescriptor) {
  // Convert the dscriptor object into a JSON string.
  const str = JSON.stringify(descriptor)

  // Add the UTF-16 JSON string to the array byte buffer, going two bytes at
  // a time.
  const data = new DataView(new ArrayBuffer(1 + 2 + 2 * str.length))
  let byteIdx = 0
  data.setUint8(byteIdx, messageType)
  byteIdx += 1
  data.setUint16(byteIdx, str.length, true)
  byteIdx += 2
  for (let i = 0; i < str.length; i++) {
    data.setUint16(byteIdx, str.charCodeAt(i), true)
    byteIdx += 2
  }
  send(data.buffer)
}

export function emitUIInteraction(descriptor: UIDescriptor) {
  console.log(
    '%c[ui]',
    'background: hotpink; color: black',
    'Emit UI Interaction ===> ',
    JSON.stringify(descriptor)
  )
  emitDescriptor(MessageType.UIInteraction, descriptor)
}

export function send(data: ArrayBuffer) {
  emitDebugEvent('afk', 'reset')
  if (dc?.readyState == 'open') {
    dc.send(data)
  }
}

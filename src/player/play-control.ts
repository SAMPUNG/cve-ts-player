import { emitUIInteraction } from '../liaison/emitter'
import { createWebSocket, ws } from '../liaison/web-socket'
import { player } from '../player/custom-element'
import { emitDebugEvent, emitEvent } from '../player/emitter'
import { onResizePlayerStyle } from '../style/events'
import { setVideoEnabled } from '../video/controls'

import { getPixelStreamingInstance } from './pixel-streaming'

export function open(levelName?: string, sceneName?: string) {
  const LevelName = levelName ?? player?.getAttribute('level-name')
  const SceneName = sceneName ?? player?.getAttribute('scene-name')
  if (LevelName && SceneName) {
    const Data = { LevelName, SceneName }
    emitUIInteraction({ Command: 'OpenLevel', Data })
  }
}

export async function run() {
  if (!player) {
    return
  }

  const name = player.getAttribute('application-name')
  if (!name) {
    return
  }

  let origin = player.getAttribute('origin')
  if (origin) {
    player.origin = origin
  } else {
    origin = player.origin
  }
  console.log('[player] origin ===> ', origin)

  getPixelStreamingInstance(name, origin).then((url) => {
    if (!url) {
      return
    }
    player?.setAttribute('url', url)
    start(url)
  }).catch((reason) => {
    emitEvent('reject', reason)
  })
}

export let reconnecting: boolean = false
export function reconnect(enable: boolean = true) {
  reconnecting = enable
}

export function start(url: string) {
  if (!player?.isConnected) {
    return
  }

  stop()

  if (reconnecting) {
    setVideoEnabled(true)
    onResizePlayerStyle()
  }
  emitDebugEvent('start', reconnecting)
  emitDebugEvent('kick', 0)

  createWebSocket(url)
}

export function stop() {
  if (!player?.isConnected) {
    return
  }

  ws?.close()
  player.disconnectedCallback()
}

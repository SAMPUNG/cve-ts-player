import wrapper from '../wrapper/element'

import { player } from '../player/custom-element'
import { emitEvent } from '../player/emitter'
import { resize } from './resolution'
import { updateVideoStreamSize } from '../video/controls'
import { setupMouseAndFreezeFrame } from '../wrapper/coords'

export function disposeResizeEvents() {
  window.removeEventListener('resize', onResizePlayerStyle, true)
  window.removeEventListener('orientationchange', onOrientationChangeHandler)
}

let orientationTimer: NodeJS.Timeout | undefined
export function onOrientationChangeHandler() {
  if (orientationTimer) {
    clearTimeout(orientationTimer)
  }
  orientationTimer = setTimeout(onResizePlayerStyle, 500)
}

export function onResizePlayerStyle() {
  if (!player?.isConnected) {
    return
  }

  updateVideoStreamSize()

  if (wrapper.classList.contains('fixed-size')) {
    setupMouseAndFreezeFrame()
    return
  }

  resize(player?.getAttribute('aspect-ratio'))

  setupMouseAndFreezeFrame()

  emitEvent('player-resize', Date.now())
}

export function registerResizeEvents() {
  window.addEventListener('resize', onResizePlayerStyle, true)
  window.addEventListener('orientationchange', onOrientationChangeHandler)
}

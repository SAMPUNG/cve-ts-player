import video from './element'

import { getBooleanAttribute, player } from '../player/custom-element'
import { emitUIInteraction } from '../liaison/emitter'

let resizeTime: number
let resizeTimer: NodeJS.Timeout

export function setVideoEnabled(enabled: boolean) {
  const media = video.srcObject as MediaStream
  media.getTracks().forEach((track) => (track.enabled = enabled))
}

export function updateVideoStreamSize() {
  if (player === undefined) {
    return
  }
  if (!getBooleanAttribute('match-viewport')) {
    return
  }
  const now = new Date().getTime()
  if (now - resizeTime > 1000) {
    emitUIInteraction({
      Command: 'SetResolution',
      Data: {
        Width: player.clientWidth,
        Height: player.clientHeight,
      },
    })
    resizeTime = new Date().getTime()
  } else {
    if (resizeTimer) {
      clearTimeout(resizeTimer)
    }
    resizeTimer = setTimeout(() => {
      emitUIInteraction({
        Command: 'SetResolution',
        Data: {
          Width: player!.clientWidth,
          Height: player!.clientHeight,
        },
      })
    }, 1000)
  }
}